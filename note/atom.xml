<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Notes</title>
  <link href="https://archive.casouri.cat/note" rel="self" />
  <updated>2021-07-23T00:00:00.00-05:00</updated>
  <author>
    <name>Yuan Fu</name>
  </author>
  <icon>https://archive.casouri.cat/favicon.png</icon>
  <id>urn:uuid:53fd03d4-ec1b-11eb-8cca-e7401fdbc2e2</id>
  
  <entry><title>自动处理网页里的全角引号和标点挤压</title><link href="https://archive.casouri.cat/note/2021/full-width-quote"/><id>urn:uuid:05c234e6-d6b3-11eb-b625-f744d8291272</id><updated>2021-09-03T13:15:00.00-05:00</updated><content type="html">&lt;h2 id="%E5%85%A8%E8%A7%92%E5%BC%95%E5%8F%B7" class="section"&gt;全角引号&lt;/h2&gt;&lt;p&gt;在 Unicode 里&lt;span class="full-width-mark"&gt;，&lt;/span&gt;问号&lt;span class="full-width-mark"&gt;、&lt;/span&gt;叹号&lt;span class="full-width-mark"&gt;、&lt;/span&gt;各种括号都有全角半角两种版本&lt;span class="full-width-mark"&gt;，&lt;/span&gt;各自有独立的编码&lt;span class="full-width-mark"&gt;；&lt;/span&gt;但因为莫名的原因&lt;span class="full-width-mark"&gt;，&lt;/span&gt;最常用的引号却不在此列&lt;span class="full-width-mark"&gt;。&lt;/span&gt;中英混排的时候想要正确显示直角和半角的引号就很头疼&lt;span class="full-width-mark"&gt;；&lt;/span&gt;搞不好的话&lt;span class="full-width-mark"&gt;，&lt;/span&gt;中文里显示半角引号还不算太违和&lt;span class="full-width-mark"&gt;，&lt;/span&gt;英文里蹦出来一个全角引号就太丑了&lt;span class="full-width-mark"&gt;。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;CSS 没法自动区别什么时候用全角引号&lt;span class="full-width-mark"&gt;、&lt;/span&gt;什么时候用半角&lt;span class="full-width-mark"&gt;，&lt;/span&gt;只能靠标记&lt;span class="full-width-mark"&gt;。&lt;/span&gt;好在还没复杂到需要手工标记的地步&lt;span class="full-width-mark"&gt;，&lt;/span&gt;只要用程序检查引号前后的字是中文还是英文&lt;span class="full-width-mark"&gt;，&lt;/span&gt;以此标记全角还是半角&lt;span class="full-width-mark"&gt;，&lt;/span&gt;就基本不会出错&lt;span class="full-width-mark"&gt;。&lt;/span&gt;我现在的办法是这样&lt;span class="full-width-mark"&gt;，&lt;/span&gt;默认字体还是英文先中文后&lt;span class="full-width-mark"&gt;：&lt;/span&gt;&lt;/p&gt;&lt;pre class="code-block"&gt;body {
  font-family: Charter, Source Han Serif CN, serif;
}&lt;/pre&gt;&lt;p&gt;需要全角的引号用 &lt;code&gt;span&lt;/code&gt; 标签包起来&lt;span class="full-width-mark"&gt;：&lt;/span&gt;&lt;/p&gt;&lt;pre class="code-block"&gt;&amp;lt;span class="full-width-quote"&amp;gt;“&amp;lt;/span&amp;gt;&lt;/pre&gt;&lt;p&gt;然后用 CSS 指定中文字体&lt;span class="full-width-mark"&gt;：&lt;/span&gt;&lt;/p&gt;&lt;pre class="code-block"&gt;span.full-width-quote {
  font-family: Srouce Han Serif CN, serif;
}&lt;/pre&gt;&lt;p&gt;怎么区别一个引号应该全角还是半角呢&lt;span class="full-width-mark"&gt;？&lt;/span&gt;我用了一个简单的判断方法&lt;span class="full-width-mark"&gt;：&lt;/span&gt;如果前或后紧挨着中文字符&lt;span class="full-width-mark"&gt;，&lt;/span&gt;就全角&lt;span class="full-width-mark"&gt;；&lt;/span&gt;如果前后都不是中文字符&lt;span class="full-width-mark"&gt;，&lt;/span&gt;就半角&lt;span class="full-width-mark"&gt;。&lt;/span&gt;我目前还没发现这个简单判断不够用的情况&lt;span class="full-width-mark"&gt;。&lt;/span&gt;这样一来还需要判断一个字符是不是中文&lt;span class="full-width-mark"&gt;，&lt;/span&gt;最简单的办法是检查字符的 Unicode codepoint 在不在中文区间内&lt;span class="full-width-mark"&gt;。&lt;/span&gt;常用汉字和标点符号在 &lt;code&gt;0x4E00&lt;/code&gt;–&lt;code&gt;0x9FFF&lt;/code&gt; 和 &lt;code&gt;0x3000&lt;/code&gt;–&lt;code&gt;0x303F&lt;/code&gt; 两个区间里&lt;span class="full-width-mark"&gt;，&lt;/span&gt;检查这两个就够了&lt;span class="full-width-mark"&gt;，&lt;/span&gt;其他的区间里都是生僻字&lt;span class="full-width-mark"&gt;。&lt;/span&gt;&lt;/p&gt;&lt;h2 id="%E6%A0%87%E7%82%B9%E6%8C%A4%E5%8E%8B" class="section"&gt;标点挤压&lt;/h2&gt;&lt;p&gt;全角引号搞好了&lt;span class="full-width-mark"&gt;，&lt;/span&gt;又会贪心标点挤压&lt;span class="full-width-mark"&gt;。&lt;/span&gt;没有标点挤压的时候&lt;span class="full-width-mark"&gt;，&lt;/span&gt;几个标点排在一起确实不大好看&lt;span class="full-width-mark"&gt;：&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;img class="half300" alt="没有标点挤压的样子" src="https://archive.casouri.cat/note/2021/full-width-quote/%E4%BE%8B%E5%AD%901.png"/&gt;
&lt;figcaption&gt;&lt;a href="https://archive.casouri.cat/note/2021/full-width-quote/https:/archive.casouri.cat/rock/day/day-48/index.html"&gt;余日摇滚第48期&lt;/a&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;挤压以后就不那么空了&lt;span class="full-width-mark"&gt;：&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;img class="half300" alt="有标点挤压的样子" src="https://archive.casouri.cat/note/2021/full-width-quote/%E4%BE%8B%E5%AD%902.png"/&gt;
&lt;figcaption&gt;&lt;a href="https://archive.casouri.cat/note/2021/full-width-quote/https:/archive.casouri.cat/rock/day/day-48/index.html"&gt;余日摇滚第48期&lt;/a&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;原理是设置 CSS 属性 &lt;code&gt;font-feature-settings: "halt"&lt;/code&gt;&lt;span class="full-width-mark"&gt;，&lt;/span&gt;启用 OpenType 的 &lt;code&gt;halt&lt;/code&gt; 特性&lt;span class="full-width-mark"&gt;。&lt;/span&gt;和全角引号一样&lt;span class="full-width-mark"&gt;，&lt;/span&gt;用程序自动识别需要挤压的标点&lt;span class="full-width-mark"&gt;，&lt;/span&gt;包在 &lt;code&gt;span&lt;/code&gt; 标签里&lt;span class="full-width-mark"&gt;。&lt;/span&gt;要注意的是&lt;span class="full-width-mark"&gt;，&lt;/span&gt;你用的字体要有 &lt;code&gt;halt&lt;/code&gt; 这个特性才行&lt;span class="full-width-mark"&gt;，&lt;/span&gt;我用的思源宋体是有的&lt;span class="full-width-mark"&gt;。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;具体怎么挤压标点符号&lt;span class="full-width-mark"&gt;，&lt;/span&gt;我没找到现成的标准或者算法&lt;span class="full-width-mark"&gt;，&lt;/span&gt;下面是我的方法&lt;span class="full-width-mark"&gt;。&lt;/span&gt;这个方法并不完整&lt;span class="full-width-mark"&gt;，&lt;/span&gt;只处理比较常见的情况&lt;span class="full-width-mark"&gt;，&lt;/span&gt;但对我来说够用了&lt;span class="full-width-mark"&gt;。&lt;/span&gt;如果读者知道更好的算法&lt;span class="full-width-mark"&gt;，&lt;/span&gt;请一定告诉我&lt;span class="full-width-mark"&gt;。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;首先&lt;span class="full-width-mark"&gt;，&lt;/span&gt;能挤压的标点符号可以分为三类&lt;span class="full-width-mark"&gt;：&lt;/span&gt;靠左&lt;span class="full-width-mark"&gt;，&lt;/span&gt;靠右&lt;span class="full-width-mark"&gt;，&lt;/span&gt;居中&lt;span class="full-width-mark"&gt;：&lt;/span&gt;&lt;/p&gt;&lt;figure&gt;&lt;img alt="各种类型的标点符号" src="https://archive.casouri.cat/note/2021/full-width-quote/%E5%90%84%E7%B1%BB%E7%AC%A6%E5%8F%B7.png"/&gt;
&lt;figcaption&gt;&lt;a href="https://archive.casouri.cat/note/2021/full-width-quote/https:/www.w3.org/TR/2020/WD-clreq-20201101"&gt;&lt;span class="full-width-mark"&gt;《&lt;/span&gt;中文排版需求&lt;span class="squeeze full-width-mark"&gt;》&lt;/span&gt;&lt;span class="full-width-mark"&gt;，&lt;/span&gt;W3C Working Draft 01 November 2020&lt;span class="full-width-mark"&gt;，&lt;/span&gt;3.1.6 标点符号的宽度调整&lt;span class="full-width-mark"&gt;，&lt;/span&gt;有修改&lt;/a&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;我们不考虑居中的符号&lt;span class="full-width-mark"&gt;，&lt;/span&gt;因为简体中文普遍不用&lt;span class="full-width-mark"&gt;，&lt;/span&gt;而我以简体中文写作&lt;span class="full-width-mark"&gt;。&lt;/span&gt;程序从头到尾遍历每个字符&lt;span class="full-width-mark"&gt;，&lt;/span&gt;决定每个字符要不要挤压&lt;span class="full-width-mark"&gt;。&lt;/span&gt;挤不挤压取决于这个字符和其前后的字符&lt;span class="full-width-mark"&gt;，&lt;/span&gt;以伪码表达为&lt;span class="full-width-mark"&gt;：&lt;/span&gt;&lt;/p&gt;&lt;pre class="code-block"&gt;遍历 字符：
  如果 此字符为靠左标点 且 后一字符为标点：
    挤压此字符
  如果 此字符为靠右标点 且 前一字符为靠右标点：
    挤压此字符&lt;/pre&gt;&lt;p&gt;这个算法运行的结果是这样&lt;span class="squeeze full-width-mark"&gt;：&lt;/span&gt;&lt;span class="full-width-mark"&gt;（&lt;/span&gt;&lt;span class="squeeze full-width-mark"&gt;（&lt;/span&gt;文字&lt;span class="squeeze full-width-mark"&gt;）&lt;/span&gt;&lt;span class="squeeze full-width-mark"&gt;）&lt;/span&gt;&lt;span class="squeeze full-width-mark"&gt;，&lt;/span&gt;&lt;span class="full-width-mark"&gt;（&lt;/span&gt;文&lt;span class="squeeze full-width-mark"&gt;）&lt;/span&gt;&lt;span class="full-width-mark"&gt;「&lt;/span&gt;字&lt;span class="squeeze full-width-mark"&gt;」&lt;/span&gt;&lt;span class="full-width-mark"&gt;。&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;a id="footref:subset" class="footref-anchor obviously-a-link" aria-label="Jump to footnote" href="#footdef%3Asubset"&gt;如果你用 &lt;code&gt;pyftsubset&lt;/code&gt; 压缩过字体文件&lt;span class="inline-footref"&gt;1&lt;/span&gt;&lt;/a&gt;&lt;span class="full-width-mark"&gt;，&lt;/span&gt;注意它默认会把 &lt;code&gt;halt&lt;/code&gt; 这样的 OTF 特性扔掉&lt;span class="full-width-mark"&gt;，&lt;/span&gt;这样一来即使加上挤压标签也没有效果&lt;span class="full-width-mark"&gt;。&lt;/span&gt;压缩的时候加上 &lt;code&gt;--layout-features='*'&lt;/code&gt; 这个选项就可以保留所有 OTF 特性了&lt;span class="full-width-mark"&gt;。&lt;/span&gt;也可以用 &lt;code&gt;--layout-features='halt'&lt;/code&gt; 只保留 &lt;code&gt;halt&lt;/code&gt; 特性&lt;span class="full-width-mark"&gt;。&lt;/span&gt;&lt;/p&gt;&lt;div id="footdef:subset" class="footdef"&gt;&lt;div class="def-footref obviously-a-link"&gt;&lt;a aria-label="Jump back to main text" href="#footref%3Asubset"&gt;1&lt;/a&gt;&lt;/div&gt;&lt;div class="def-footdef"&gt;参见 &lt;a href="https://archive.casouri.cat/note/2019/reduce-font-loading-time-in-my-blog/index.html"&gt;&lt;em&gt;Reduce Font Loading Time in My Blog&lt;/em&gt;&lt;/a&gt;&lt;span class="full-width-mark"&gt;。&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;h2 id="%E7%A0%B4%E6%8A%98%E5%8F%B7" class="section"&gt;破折号&lt;/h2&gt;&lt;p&gt;我还发现破折号有时会显示成 em dash&lt;span class="full-width-mark"&gt;（&lt;/span&gt;因为破折号在 Unicode 里其实就是 em dash&lt;span class="squeeze full-width-mark"&gt;）&lt;/span&gt;&lt;span class="full-width-mark"&gt;。&lt;/span&gt;解决方法和全角引号一样&lt;span class="full-width-mark"&gt;，&lt;/span&gt;包上全角的 &lt;code&gt;span&lt;/code&gt; 标签就可以了&lt;span class="full-width-mark"&gt;——&lt;/span&gt;这样就能正确显示破折号&lt;span class="full-width-mark"&gt;。&lt;/span&gt;&lt;/p&gt;</content></entry>
</feed>
