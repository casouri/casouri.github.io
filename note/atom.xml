<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Notes</title>
  <link href="https://archive.casouri.cat/note" rel="self" />
  <updated>2021-07-23T00:00:00.00-05:00</updated>
  <author>
    <name>Yuan Fu</name>
  </author>
  <icon>https://archive.casouri.cat/favicon.png</icon>
  <id>urn:uuid:53fd03d4-ec1b-11eb-8cca-e7401fdbc2e2</id>
  
  <entry><title>全角引号，终于好了</title><link href="https://archive.casouri.cat/note/2021/full-width-quote"/><id>urn:uuid:05c234e6-d6b3-11eb-b625-f744d8291272</id><updated>2021-06-26T00:00:00.00-05:00</updated><content type="html">&lt;h2 id="%E5%85%A8%E8%A7%92%E5%BC%95%E5%8F%B7" class="section"&gt;全角引号&lt;/h2&gt;&lt;p&gt;在 Unicode 里，问号、叹号、各种括号都有全角半角两种版本，各自有独立的编码；但因为莫名的原因，最常用的引号却不在此列。中英混排的时候想要正确显示直角和半角的引号就很头疼；搞不好的话，中文里显示半角引号还不算太违和，英文里蹦出来一个全角引号就太丑了。&lt;/p&gt;&lt;p&gt;CSS 没法自动区别什么时候用全角引号、什么时候用半角，只能靠标记。好在还没复杂到需要手工标记的地步，只要用程序检查引号前后的字是中文还是英文，以此标记全角还是半角，就基本不会出错。我现在的办法是这样，默认字体还是英文先中文后：&lt;/p&gt;&lt;pre class="code-block"&gt;body {&lt;br/&gt;  font-family: Charter, Source Han Serif CN, serif;&lt;br/&gt;}&lt;/pre&gt;&lt;p&gt;需要全角的引号用 &lt;code&gt;span&lt;/code&gt; 标签包起来：&lt;/p&gt;&lt;pre class="code-block"&gt;&amp;lt;span class="full-width-quote"&amp;gt;“&amp;lt;/span&amp;gt;&lt;/pre&gt;&lt;p&gt;然后用 CSS 指定中文字体：&lt;/p&gt;&lt;pre class="code-block"&gt;span.full-width-quote {&lt;br/&gt;  font-family: Srouce Han Serif CN, serif;&lt;br/&gt;}&lt;/pre&gt;&lt;p&gt;怎么区别一个引号应该全角还是半角呢？我用了一个简单的判断方法：如果前或后紧挨着中文字符，就全角；如果前后都不是中文字符，就半角。我目前还没发现这个简单判断不够用的情况。这样一来还需要判断一个字符是不是中文，最简单的办法是检查字符的 Unicode codepoint 在不在中文区间内。常用汉字和标点符号在 &lt;code&gt;0x4E00&lt;/code&gt;–&lt;code&gt;0x9FFF&lt;/code&gt; 和 &lt;code&gt;0x3000&lt;/code&gt;–&lt;code&gt;0x303F&lt;/code&gt; 两个区间里，检查这两个就够了，其他的区间里都是生僻字。&lt;/p&gt;&lt;h2 id="%E6%A0%87%E7%82%B9%E6%8C%A4%E5%8E%8B" class="section"&gt;标点挤压&lt;/h2&gt;&lt;p&gt;全角引号搞好了，又会贪心标点挤压。没有标点挤压的时候，几个标点排在一起确实不大好看：&lt;/p&gt;&lt;figure&gt;&lt;img alt="没有标点挤压的样子" style="width: 50%;" src="https://archive.casouri.cat/note/2021/full-width-quote/%E4%BE%8B%E5%AD%901.png"/&gt;
&lt;figcaption&gt;&lt;a href="https://archive.casouri.cat/note/2021/full-width-quote/https:/archive.casouri.cat/rock/day/day-48/index.html"&gt;余日摇滚第48期&lt;/a&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;挤压以后就不那么空了：&lt;/p&gt;&lt;figure&gt;&lt;img alt="有标点挤压的样子" style="width: 50%;" src="https://archive.casouri.cat/note/2021/full-width-quote/%E4%BE%8B%E5%AD%902.png"/&gt;
&lt;figcaption&gt;&lt;a href="https://archive.casouri.cat/note/2021/full-width-quote/https:/archive.casouri.cat/rock/day/day-48/index.html"&gt;余日摇滚第48期&lt;/a&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;原理是设置 CSS 属性 &lt;code&gt;font-feature-settings: "halt"&lt;/code&gt;，启用 OpenType 的 &lt;code&gt;halt&lt;/code&gt; 特性。和全角引号一样，用程序自动识别需要挤压的标点，包在 &lt;code&gt;span&lt;/code&gt; 标签里。要注意的是，你用的字体要有 &lt;code&gt;halt&lt;/code&gt; 这个特性才行，我用的思源宋体是有的。&lt;/p&gt;&lt;p&gt;具体怎么挤压标点符号，我没找到现成的标准或者算法，下面是我的方法。这个方法并不完整，只处理比较常见的情况，但对我来说够用了。如果读者知道更好的算法，请一定告诉我。&lt;/p&gt;&lt;p&gt;首先，能挤压的标点符号可以分为三类：靠左，靠右，居中：&lt;/p&gt;&lt;figure&gt;&lt;img alt="各种类型的标点符号" src="https://archive.casouri.cat/note/2021/full-width-quote/%E5%90%84%E7%B1%BB%E7%AC%A6%E5%8F%B7.png"/&gt;
&lt;figcaption&gt;&lt;a href="https://archive.casouri.cat/note/2021/full-width-quote/https:/www.w3.org/TR/2020/WD-clreq-20201101"&gt;中文排版需求，W3C Working Draft 01 November 2020，3.1.6 标点符号的宽度调整，有修改&lt;/a&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;我们只处理连续两个标点的情况，居中的标点也不考虑。连续两个标点的时候有两种处理方法：挤压左边的，或者挤压右边的。如果左边的标点是靠左的类型，那就挤压左边的标点。比如&lt;span class="full-width-mark"&gt;“&lt;/span&gt;&lt;code&gt;&lt;span class="squeeze full-width-mark"&gt;》&lt;/span&gt;&lt;span class="full-width-mark"&gt;）&lt;/span&gt;&lt;/code&gt;&lt;span class="squeeze full-width-mark"&gt;”&lt;/span&gt;&lt;span class="full-width-mark"&gt;，&lt;/span&gt;左边的右书名号靠左，所以挤压右书名号，把它右边的空白挤掉。如果右边的标点是靠右的类型，挤压右边地标点。比如&lt;span class="full-width-mark"&gt;“&lt;/span&gt;&lt;code&gt;&lt;span class="full-width-mark"&gt;（&lt;/span&gt;&lt;span class="squeeze full-width-mark"&gt;《&lt;/span&gt;&lt;/code&gt;&lt;span class="squeeze full-width-mark"&gt;”&lt;/span&gt;&lt;span class="full-width-mark"&gt;，&lt;/span&gt;右边的左书名号靠右，那就挤压它，把左边的空白挤掉。如果左边标点靠左，右边标点靠右（&lt;code&gt;&lt;span class="squeeze full-width-mark"&gt;》&lt;/span&gt;&lt;span class="full-width-mark"&gt;《&lt;/span&gt;&lt;/code&gt;&lt;span class="squeeze full-width-mark"&gt;）&lt;/span&gt;&lt;span class="full-width-mark"&gt;，&lt;/span&gt;挤压哪个都可以；如果左边标点靠右，右边标点靠左（&lt;code&gt;《》&lt;/code&gt;&lt;span class="squeeze full-width-mark"&gt;）&lt;/span&gt;&lt;span class="full-width-mark"&gt;，&lt;/span&gt;那就不挤压。&lt;/p&gt;&lt;p&gt;只处理连续两个标点可能有点怪，这其实是因为实现方便：程序从头到尾一个个字符看过去，如果遇到一个可挤压标点，看看后面那个是不是标点，如果是的话按上面的方法挤压。这样一来，如果有连续三个标点，前面两个会正常挤压；到了第三个标点，因为它后面没有标点，就不会挤压了。连续四个的话就会前面两个一起挤压，后面两个一起挤压。三个标点的时候，我可以用零距空格控制挤压前面两个还是后面两个：如果在第一个标点后面插一个零距空格，程序就会转而挤压后面两个标点。&lt;/p&gt;&lt;p&gt;如果你用 &lt;code&gt;pyftsubset&lt;/code&gt; 压缩过字体文件&lt;span class="footnote"&gt;&lt;a id="footref:subset" class="inline-footref" aria-label="Jump to footnote" href="#footdef%3Asubset"&gt;1&lt;/a&gt;&lt;/span&gt;，注意它默认会把 &lt;code&gt;halt&lt;/code&gt; 这样的 OTF 特性扔掉。加上 &lt;code&gt;--layout-features='*'&lt;/code&gt; 这个选项就可以保留所有 OTF 特性了。也可以用 &lt;code&gt;--layout-features='halt'&lt;/code&gt; 只保留 &lt;code&gt;halt&lt;/code&gt; 特性。&lt;/p&gt;&lt;div id="footdef:subset" class="footdef"&gt;&lt;div class="ref-footref obviously-a-link"&gt;&lt;a aria-label="Jump back to main text" href="#footref%3Asubset"&gt;1&lt;/a&gt;&lt;/div&gt;&lt;div class="def-footdef"&gt;参见 &lt;a href="https://archive.casouri.cat/note/2021/full-width-quote/http:/localhost:8080/note/2019/reduce-font-loading-time-in-my-blog/index.html"&gt;Reduce Font Loading Time in My Blog&lt;/a&gt;。&lt;/div&gt;&lt;/div&gt;</content></entry>
</feed>
